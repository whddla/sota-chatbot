{% extends 'layout/layout.html' %}
{%load static%}
{%block content%}
<link rel="stylesheet" href="{% static 'css/index.css' %}">
<div style="width: 1500px; margin: 0 auto;">
    <div style="display: inline-flex; place-content: center;padding: 0px 74px;">
        <div id='show' style="width: 760px; height: 750px; border: 1px solid #333; margin-right: 30px;">
        </div>
        <input id="old" name="old" type="text" value="None">
        <!-- ì±—ë´‡ -->
        <div class="main_wrap">
            <div id="wrap" class="wrap">
                <div class="chatBox" id="chatbox" style="padding-bottom: 120px;">
                    <div class="header">
                        <div class="title-wrap">
                            <h1 class="title">SOTA ì±—ë´‡</h1>
                        </div>
                    </div>
                    <div class="chat-bot">
                    </div>
                </div>
            </div>
            <div class="chatfooter">
                <table>
                    <tr>
                        <td width="90%" style="display: table-cell;vertical-align: middle;width: auto;padding: 9px 8px 9px 13pt;position: relative;">
                            <input id="chattext" placeholder="ì±—ë´‡ì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”" style="background-color: rgb(243, 244, 246);border: 0px;height: 50px;">
                        </td>
                        <td width="10%">
                            <button id="sendbtn">SEND</button>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // document.getElementById('footer').hide()
 
$(document).ready(function(){    
    document.getElementById('footer').style.display='none'
    $chatbox = $("#chatbox");
    bottext ="<div class=chat-bot><div class=bot-profile><div class=img style=background-image:none;margin-top:14px;><img src=https://openclipart.org/image/800px/262355 alt=ì±—ë´‡></div><div class=name>ì±—ë´‡</div></div><div class=bot-talk><div class=txt><div>"+"ì•ˆë…•í•˜ì„¸ìš” ì–´ë–¤ ì—…ë¬´ë¥¼ ë„ì™€ë“œë¦´ê¹Œìš”?"+"</div></div><div class=time><div>"+day.getHours()+"ì‹œ "+day.getMinutes()+"ë¶„"+"</div></div></div></div>";
    $chatbox.append(bottext);
});

// ì±„íŒ…ì‹œê°„
var day = new Date();

    $(function(){

    // SEND ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜
    $("#sendbtn").click(function(){
        send_message();
    });

    // ENTER key ê°€ ëˆŒë¦¬ë©´
    $("#chattext").keyup(function(event){
        if(event.keyCode == 13){
            send_message();
        }
    });
});

function send_message(){
const chattext = $("#chattext").val().trim();
const show=$("#show")

// ì…ë ¥í•œ ë©”ì„¸ì§€ê°€ ì—†ìœ¼ë©´ ë¦¬í„´
if(chattext == ""){
    $("#chattext").focus();
    return;
}

// ì…ë ¥í•œ ì±„íŒ… ì¶œë ¥

addtext = "<div class=customer><div class=customer-wrap><div class=txt><div>"+chattext+"</div></div><div class=time><div>"+day.getHours()+"ì‹œ "+day.getMinutes()+"ë¶„"+"</div></div></div></div>";
$("#chatbox").append(addtext);    
var old1 = $("#old").val()

// API ì„œë²„ì— ë³´ë‚¼ ë°ì´í„° ì¤€ë¹„
const jsonData = { 
    query: chattext,
    old:old1,
    bottype: "WebClient",
};
if(chattext=='ì²˜ìŒìœ¼ë¡œ'){
    $('input[name=old]').attr('value',"None")

}

$.ajax({
    url: 'http://127.0.0.1:5000/TEST',
    type: "POST",
    data: JSON.stringify(jsonData),
    dataType: "JSON",  // ì‘ë‹µë°›ì„ ë°ì´í„° íƒ€ì…
    contentType: "application/json; charset=utf-8",  
    crossDomain: true,
    success: function(response){
        console.log(response)
        // response.Answer ì— ì±—ë´‡ì˜ ì‘ë‹µë©”ì„¸ì§€ê°€ ë‹´ê²¨ ìˆë‹¤
        $chatbox = $("#chatbox");
        // ë‹µë³€ ì¶œë ¥
        

        bottext ="<div class=chat-bot><div class=bot-profile><div class=img style=background-image:none;><img src=https://openclipart.org/image/800px/262355 alt=ì±—ë´‡></div><div class=name>ì±—ë´‡</div></div><div class=bot-talk><div class=txt><div>"+response.Answer+"</div></div><div class=time><div>"+day.getHours()+"ì‹œ "+day.getMinutes()+"ë¶„"+"</div></div></div></div>";
        $chatbox.append(bottext);
        if(response.Intent=='ì¸ì‚¬'){
            
            $show=$("#show")
            $show.append(response.Intent)
            bottext = "<div style='margin:2% 0%;text-align:left;'><span style='padding:1% 2%;background-color:#ddd;border-radius:10px;color:#424242;display:inline-block'><b>" + "<br>ì§ˆë¬¸ ì˜ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”" + "</b></span></div>";
                $chatbox.append(bottext)
                intent_list=['ê³„ì¢Œì¡°íšŒ','ìƒí’ˆì¡°íšŒ','ì´ì²´','ìƒí™˜ë°ë‚©ë¶€','ë¶„ì‹¤ì‹ ê³ ']
                button_str = "<div id='buttons'>"
                let i = 0
                for(inte of intent_list){
                    button_str += `<button class='button small primary' id=${i} style='margin: 3px;' onclick=' "${chattext}"'>${inte}</button>`
                    i += 1;
                }
                button_str += "</div>"
                $chatbox.append(button_str)
                $("#0").click(function(){
                    const jsonData = {
                        query: 'ì¹´ë“œ',
                        bottype: "WebClient",
                    };
                    $.ajax({
                        
                            // url: 'http://127.0.0.1:8000/service/lookup',
                            // type:"GET",
                            // cache: false,
                            // success: function(data,status){
                            //     if(status == 'success') 
                            //     data.parseXML
                            // }
                           
                                url: 'http://127.0.0.1:5000/chatbot/TEST',
                                type: "POST",
                                data: JSON.stringify(jsonData),
                                dataType: "JSON",  // ì‘ë‹µë°›ì„ ë°ì´í„° íƒ€ì…
                                contentType: "application/json; charset=utf-8",  
                                crossDomain: true,
                                success: function(response){
                                    
                                    // response.Answer ì— ì±—ë´‡ì˜ ì‘ë‹µë©”ì„¸ì§€ê°€ ë‹´ê²¨ ìˆë‹¤
                                    $chatbox = $("#chatbox");
                                    // ë‹µë³€ ì¶œë ¥
                        
                                    bottext ="<div class=chat-bot><div class=bot-profile><div class=img style=background: none;><img src=https://openclipart.org/image/800px/262355 alt=ì±—ë´‡></div><div class=name>ì±—ë´‡</div></div><div class=bot-talk><div class=txt><div>"+response.Answer+"</div></div><div class=time><div>"+day.getHours()+"ì‹œ "+day.getMinutes()+"ë¶„"+"</div></div></div></div>";
                                    $chatbox.append(bottext);
                                    
                       
                                }
                   
                 });
                })
                 $("#1").click(function(){
                    console.log('didi')
                 });
                 $("#2").click(function(){
                    console.log('didi')
                 });
                 $("#3").click(function(){
                    console.log('didi')
                 });
                // $chatbox.attr('src', 'http://127.0.0.1:5000/chatbot/TEST')
            }
            
        else if(response.Intent == 'ì¡°íšŒ'){
                        a=JSON.stringify(response.NER[0][0].slice(0,2)) //a=ë‚ ì§œ

                        
                        
                        $show=$("#show")
                        for(i of response.result[0]){
                            $show.append(i)
                        }
                            

                        //$show.append(JSON.parse(a))
                        if(response.old='ì¡°íšŒ'){
                            console.log('wefwef')
                            $('input[name=old]').attr('value',response.old)

                        }
//                         $.ajax({
                        
//                         url:'http://127.0.0.1:8000/service/lookup',
//                         type:"GET",
//                         dataType:"html",
//                         success: function(data,status){
//                           if(status == 'success')
                            
//                         //     $show.append(data)
                       
//                         //  }
//                         })   
//                         .done(function(html) {
                        
//                         $show.html(html)}
//                             //html(html.getElementById('card')
                           
//  }
// )
            }
        else if(response.Intent =='ì´ì²´'){
            $show=$("#show")
            $chatbox = $("#chatbox")
            let i=1
            button_str = "<div id='buttons'>"
            for(ca of response.card){
                button_str += `<button class='button small primary' id=${i} style='margin: 3px;' value=${ca}>${ca}</button>`
                
                i+=1
            }
            button_str += "</div>"
            $chatbox.append(button_str)

            //urlì€ ë¬´ì¡°ê±´ í”Œë¼ìŠ¤í¬ë¡œ ë³´ë‚´ëŠ”ê±°ì”ì•„ ê·¸ëŸ¼ ìš°ë¦¬ urlì„ í”Œë¼ìŠ¤í¬ë¡œ ê°€ê²Œ í•˜ë©´ ì–´ë–¤ê°€?
            $("#1").click(function(){
                    $show=$("#show")
                    $b=$(".button")
                    console.log($b.val())
                    
                   
                    const jsonData = { 
                        query:$b.val(),
                        old:'ì´ì²´',
                        bottype: "WebClient",
                                    };
                        $.ajax({
                           
                            url: 'http://127.0.0.1:5000/TEST',
                            type: "POST",
                            data: JSON.stringify(jsonData),
                            dataType: "JSON",  // ì‘ë‹µë°›ì„ ë°ì´í„° íƒ€ì…
                            contentType: "application/json; charset=utf-8",  
                            crossDomain: true,
                            success: function(response){
                                        console.log(response)
                                        text ="<div class=chat-bot><div class=bot-profile><div class=img style=background-image:none;><img src=https://openclipart.org/image/800px/262355 alt=ì±—ë´‡></div><div class=name>ì±—ë´‡</div></div><div class=bot-talk><div class=txt><div>"+response.myac+"ì—ì„œ"+response.Answer+"</div></div><div class=time><div>"+day.getHours()+"ì‹œ "+day.getMinutes()+"ë¶„"+"</div></div></div></div>";
                                        $show.append(text)
                                        
                            }
                            
                        
                                 



                        })

            
                    });
        }
        else if(response.Intent =='ìƒí’ˆ'){
                
                   print('ğŸ’œğŸ’™ğŸ’›')
            // === === === ì±—ë´‡ ë™ì‘ === === ===
                answerText = response.Answer    
                
            if (response.Intent2 == 'ìƒí’ˆì¡°íšŒ'){
                    intent_list = [ "ëŒ€ì¶œìƒí’ˆ", "ì ê¸ˆìƒí’ˆ", "ì¹´ë“œìƒí’ˆ"]
                    bottext = "<div style='margin:2% 0%;text-align:left;'><span style='padding:1% 2%;background-color:#ffcd48;border-radius:10px;color:#424242;display:inline-block'><b>" + 
                       + "<br>" + "</b></span></div>";
                    button_str = "<div id='buttons' > "
                    let i = 0
                    for(inte of intent_list){
                        button_str += `<button class='button small primary' id=${i} style='margin: 3px;' value=${inte}>${inte}</button>`
                        i += 1;
                    }
                    button_str += "<br>ğŸ’œğŸ’™ğŸ’›</div>"
                    $chatbox.append(button_str)
                    $("#1").click(function(){
                        $show=$("#show")
                        $b=$(".button")
                        console.log($b.val())
                        const jsonData = { 
                                step:2,
                                query:$b.val(),
                                old:'ìƒí’ˆ',
                                bottype: "WebClient",
                                    };
                        $.ajax({
                           
                            url: 'http://127.0.0.1:5000/TEST',
                            type: "POST",
                            data: JSON.stringify(jsonData),
                            dataType: "JSON",  // ì‘ë‹µë°›ì„ ë°ì´í„° íƒ€ì…
                            contentType: "application/json; charset=utf-8",  
                            crossDomain: true,
                            success: function(response){
                                        console.log(response)
                                        text ="<div class=chat-bot><div class=bot-profile><div class=img style=background-image:none;><img src=https://openclipart.org/image/800px/262355 alt=ì±—ë´‡></div><div class=name>ì±—ë´‡</div></div><div class=bot-talk><div class=txt><div>"+response.answer+"</div></div><div class=time><div>"+day.getHours()+"ì‹œ "+day.getMinutes()+"ë¶„"+"</div></div></div></div>";
                                        $chatbox.append(text)
                                        $show.html(response.url)

                            }


                        })



                    
                 });

        }
    }
        // ìŠ¤í¬ë¡¤ ì¡°ì •í•˜ê¸°
    $("#wrap").animate({scrollTop: $("#wrap").prop('scrollHeight')});
    
    // ë¨¼ì € ì…ë ¥í–ˆë˜ ë‚´ìš©ì€ ì§€ìš°ê¸°
    $("#chattext").val("");
    $("#chattext").focus();
    }
})
}
function parseXML(xmlDOM) {
	
	const table = [];
	table.push("<tr><th>í˜¸ì„ </th><th>ì—­ëª…</th><th>ìŠ¹ì°¨</th><th>í•˜ì°¨ì¸ì›</th></tr>");
    //table.push("$(xmlDOM).find('list1')")
	$(xmlDOM).find("list1").each(function(){
		
        table.push(`
            <tr>
                <td>ì‚´ë ¤ì£¼ì„¸ìš”</td>
            </tr>
        `);

	});
   a=xmlDOM.getElementById('info')
   consol.log(a)
	return table
}
 // end 
</script>
{%endblock%}